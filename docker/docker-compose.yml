# ViperX-300S AprilTag Grasping System - Docker Compose Configuration
# 
# This configuration provides:
# - USB device passthrough for robot arm (Dynamixel U2D2) and camera (RealSense D435)
# - X11 display forwarding for RViz2 and GUI applications
# - Host network mode for simplified ROS2 DDS communication
# - Volume mounts for live code editing
#
# Usage:
#   Build:  docker compose build
#   Start:  docker compose up -d
#   Enter:  docker exec -it viperx300s_robot bash
#   Stop:   docker compose down

services:
  viperx300s:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    image: viperx300s-ros2:humble
    container_name: viperx300s_robot
    
    # Privileged mode for full USB device access (required for hardware control)
    privileged: true
    
    # Host network mode simplifies ROS2 DDS communication (no port mapping needed)
    network_mode: host
    
    # Environment Variables
    environment:
      # X11 Display (for RViz2, GUI applications)
      - DISPLAY=${DISPLAY}
      - QT_X11_NO_MITSHM=1
      - XAUTHORITY=/tmp/.docker.xauth
      
      # ROS2 Configuration
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - ROS_LOCALHOST_ONLY=0
      
      # NVIDIA GPU Support (uncomment if using GPU features)
      # - NVIDIA_VISIBLE_DEVICES=all
      # - NVIDIA_DRIVER_CAPABILITIES=all
    
    # USB Device Passthrough
    devices:
      # ViperX-300S Robot Arm (Dynamixel U2D2 - FTDI USB-to-Serial Converter)
      # Note: Device name may vary. Check with 'ls -l /dev/ttyUSB*' on host
      - /dev/ttyUSB0:/dev/ttyUSB0:rwm
      
      # Intel RealSense D435 Camera (USB bus access for all USB devices)
      - /dev/bus/usb:/dev/bus/usb:rwm
      
      # Video devices (RealSense camera streams)
      # Multiple video devices support multiple cameras or camera streams (RGB, depth, IR)
      - /dev/video0:/dev/video0:rwm
      - /dev/video1:/dev/video1:rwm
      - /dev/video2:/dev/video2:rwm
      - /dev/video3:/dev/video3:rwm
      - /dev/video4:/dev/video4:rwm
      - /dev/video5:/dev/video5:rwm
    
    # Volume Mounts
    volumes:
      # Project root directory (live code editing)
      - ../:/workspace:rw
      
      # X11 socket for GUI applications (RViz2, MoveIt2 visualization)
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - /tmp/.docker.xauth:/tmp/.docker.xauth:rw
      
      # Shared memory for ROS2 DDS communication (improves performance)
      - /dev/shm:/dev/shm
      
      # Persist bash history (optional - uncomment to enable)
      # - ./bash_history:/root/.bash_history:rw
    
    # Working directory inside container
    working_dir: /workspace
    
    # Interactive terminal support
    stdin_open: true
    tty: true
    
    # Container restart policy
    restart: unless-stopped
    
    # NVIDIA GPU Configuration (uncomment to enable GPU support)
    # runtime: nvidia
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all  # Use all GPUs, or specify count (e.g., count: 1)
    #           capabilities: [gpu, compute, utility]
    
    # Resource Limits (optional - uncomment to enable)
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '4'      # Limit to 4 CPU cores
    #       memory: 8G     # Limit to 8GB RAM
    
    # Keep container running
    command: sleep infinity
